on: [push]
jobs:
  connect:
    # macos-latest
    # ubuntu-latest
    # windows-2022
    # windows-2019
    # For more see <https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners>
    runs-on: ubuntu-latest
    steps:
      - run: |
            sudo bash <<'OUTEREOF' | sudo tee /var/log/github-action-1.log
            set -x

            mkdir /etc/possibly_second_ssh
            cd /etc/possibly_second_ssh
            echo "${{secrets.PRIVATE_KEY}}" >ssh_host_ed25519_key
            chmod 600 ssh_host_ed25519_key
            cat <<EOF >sshd_config
            PermitRootLogin prohibit-password
            EOF

            test -d /root/.ssh || mkdir /root/.ssh
            cat <<EOF | base64 -d >>/root/.ssh/authorized_keys
            c3NoLWVkMjU1MTkgQUFBQUMzTnphQzFsWkRJMU5URTVBQUFBSUY1dmd5Q2VCUX
            lOR0JpeDliaVpHM1NBRjFoekhNczhGRDI1WXNXS1NmUGIgZnJhbmtzZWlmZmVy
            dGhAcG9zdGVvLm5ldAo=
            EOF

            /usr/sbin/sshd -D -e -p 2233 \
                -h $PWD/ssh_host_ed25519_key \
                -f $PWD/sshd_config \
                >/var/log/possibly-second-sshd.log &

            OUTEREOF
            bash <<EOF | sudo tee /var/log/github-action-2.log
            set -x

            script /dev/null                    # This ensures tty allocation
            ssh -o "StrictHostKeyChecking=no" \
                -R niubjozq:2233:localhost:2233 \
                serveo.net
            EOF
#on: [push]
#jobs:
#  Test-Connection:
#    runs-on: ubuntu-latest
#    steps:
#      - run: |
#            exit 0
#
#            mkdir ~/.ssh
#            echo "${{secrets.PRIVATE_KEY}}" > ~/.ssh/id_ed25519
#            chmod 600 ~/.ssh/id_ed25519
#
#
#            exit 0
#            which ssh
#            pwd
#            whoami
#            which apt
#            echo "${{secrets.PRIVATE_KEY}}" > priv.key.echo
#            printf "%s" "${{secrets.PRIVATE_KEY}}" > priv.key.printf
#            wc priv.key.*
#            echo "${{secrets.PRIVATE_KEY}}"|tr -d :space:|wc -c
#            head -n1 priv.key.*
#            tail -n1 priv.key.*
#            md5sum priv.key.*
#            exit 0
#            which ping && ping -c2 tilde.club || true
#            which nc && timeout 5 nc tilde.club 22 || true
