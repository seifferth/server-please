on: [push]
jobs:
  connect:
    # macos-latest
    # ubuntu-latest
    # windows-2022
    # windows-2019
    # For more see <https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners>
    runs-on: ubuntu-latest
    steps:
      - run: |
            export main_script_pid=$$
            sudo bash -x <<'OUTEREOF' | sudo tee /var/log/server-setup.log
            echo $main_script_pid >/var/run/main_github_action_script.pid
            mv /etc/ssh /etc/ssh.orig; mkdir /etc/ssh
            echo "${{secrets.PRIVATE_KEY}}" > /etc/ssh/ssh_host_ed25519_key
            chmod 600 /etc/ssh/ssh_host_ed25519_key
            cat <<EOF >/etc/ssh/sshd_config
            PermitRootLogin prohibit-password
            EOF
            test -d /root/.ssh || mkdir /root/.ssh
            test -f /root/.ssh/authorized_keys &&
                mv /root/.ssh/authorized_keys{,.orig}
            cat <<EOF >/root/.ssh/authorized_keys
            ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIF5vgyCeBQyNGBix9biZG3SAF1hzHMs8FD25YsWKSfPb frankseifferth@posteo.net
            EOF
            /usr/sbin/sshd -D
            OUTEREOF
            bash <<EOF
            script /dev/null                    # This ensures tty allocation
            ssh -o "StrictHostKeyChecking=no" \
                -R niubjozq:2233:localhost:22 \
                serveo.net
            EOF
#on: [push]
#jobs:
#  Test-Connection:
#    runs-on: ubuntu-latest
#    steps:
#      - run: |
#            exit 0
#
#            mkdir ~/.ssh
#            echo "${{secrets.PRIVATE_KEY}}" > ~/.ssh/id_ed25519
#            chmod 600 ~/.ssh/id_ed25519
#
#
#            exit 0
#            which ssh
#            pwd
#            whoami
#            which apt
#            echo "${{secrets.PRIVATE_KEY}}" > priv.key.echo
#            printf "%s" "${{secrets.PRIVATE_KEY}}" > priv.key.printf
#            wc priv.key.*
#            echo "${{secrets.PRIVATE_KEY}}"|tr -d :space:|wc -c
#            head -n1 priv.key.*
#            tail -n1 priv.key.*
#            md5sum priv.key.*
#            exit 0
#            which ping && ping -c2 tilde.club || true
#            which nc && timeout 5 nc tilde.club 22 || true
